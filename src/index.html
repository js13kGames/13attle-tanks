<!DOCTYPE html><head><title>Unit Game</title></head><canvas id=c width=1080 height=1080></canvas>
<script src="ZzFXMicro.min.js"></script>
<script src="config.js"></script>
<script src="utils.js"></script>
<script src="GameObject.js"></script>
<script src="LevelMap.js"></script>
<script src="gameObjects.js"></script>
<script>
const SCENES = {
  START: 1,
  LEVEL: 2,
  GAMEOVER: 3,
};
let globalScale = 1;
let time = tDiff = 0;
let scene = 1;
let cameraPos = null;
let objList = [];
let SCREEN_SIZE = vec2(1080);

let DEBUG_COLLISIONS = [];

const TANK_COLOR = BLUE;
const TANK_SIZE = vec2(80, 100);
const TANK_SPEED = new Speed(300, 0, 600, 1000); //per second
const TANK_ROTATE_SPEED = new Speed(3, 0, 12, 20); //per second
const TANK_FIRING_RATE = 1; // per second
const BULLET_SIZE = 10;
const BULLET_SPEED = new Speed(500, 1);

const MAP_DIMENSIONS = vec2(20);

const SPAWN_ENEMIES = 0;
const THINK_RATE = .02;
const WAIT_RATE = .5;
const PLAYER_DETECT_RANGE = 700;
const ENEMY_ATTACK_RANGE = 300;

const currMap = new LevelMap({pathLen: 4, cellSize: 1e3});
const player = new PlayerUnit(currMap.size.scale(.5), 1);

for (i = SPAWN_ENEMIES; i--;) new EnemyUnit(vec2(i * 3 + 3, 5).scale(TILE_SIZE));

const keys = {};
onkeydown=onkeyup=e=> {
  //wasd, zqsd, arrow keys, space
  // - u, l, r, d: WASD/ZQSD/arrow keys
  // - s: space
  // - S: shift
  // - E: enter
  // - R, T, Y, X, C, V, B, N, F, J: letters
  // Ex: if(keys.r) { /* move to the right */ }
  // Source: https://github.com/xem/miniGameTemplate/blob/gh-pages/index.html
  keys['E**S***************s****lurd************************lBCr*F***J***N**lRdT*VuXYu'[e.which-13]]=e.type[5]
};

window.addEventListener("wheel", e => {
  const direction = (e.detail < 0) ? 1 : (e.wheelDelta > 0) ? 1 : -1;
  globalScale = Math.min(3, Math.max(0.2, globalScale + direction * .2));
});

/***************************/ E=t=>{x.reset(tDiff = t - time)//loop and clear canvas
time = t;

// player controls
if (!player.isDead) {
  player.move(keys.u ? 1 : keys.d ? -1 : 0);
  player.rotate(keys.r ? 1 : keys.l ? -1 : 0);
  player.isFiring = keys.s;
}

// update
objList = objList.filter(o => !o.delete).sort((a, b) => a.isDead ? -1 : (a.pos?.y - a.center.y) - (b.pos?.y - b.center.y));
cameraPos = player.pos.copy();
for(o of objList)o.update();

//check collisions
DEBUG_COLLISIONS = [];
const len = objList.length;
for(i=0;i<len-1;i++)for(j=i+1;j<len;j++)
if(collided(o=objList[i],p=objList[j])){o.collidedWith(p);p.collidedWith(o);}

// render
currMap.render(time);
for(o of objList)o.render(time)

// draw stats
x.font="16px'";
x.fillStyle="black";
let startPos = vec2(50, 30);
[
  `objList.length: ${objList.length}`,
  ...player.toString(),
  ...objList[2].toString(),
  ...objList.filter(o => o instanceof Bullet).map(o => o.toString().join`, `),
  JSON.stringify(keys),
  ...DEBUG_COLLISIONS,
].map((s, i) => x.fillText(s, startPos.x, startPos.y + (i * 30)))





/*end of loop*/};c.width=c.height=1080;x=c.getContext`2d`,F=M=0,onload=U=e=>{requestAnimationFrame(U);if(F&&e<M-2)return;M=Math.max(M+1e3/60,e);T=F/60;if(T*60|0!=F++)T+=1e-6;E(T)}
</script><style>html,body{background:#222;display:flex;justify-content:center;align-items:center;height:100%;margin:0}#c{background:white;max-height:100%;max-width:100%}

/*disable text highlight. Source: https://github.com/xem/miniGameTemplate/blob/gh-pages/index.html*/
* {
  -webkit-tap-highlight-color: transparent;
  -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
  -webkit-user-select: none;
  -ms-user-select: none;
  user-select: none;
}
